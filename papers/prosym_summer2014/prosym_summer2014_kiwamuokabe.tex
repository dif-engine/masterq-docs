% withpage: ページ番号をつける (著者確認用)
% english: 英語原稿用フォーマット
\documentclass{ipsjprosym}
%\documentclass[withpage,english]{ipsjprosym}

\usepackage[dvips]{graphicx}
\usepackage{latexsym}

\begin{document}

% Title, Author %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{ATS言語を使って不変条件をAPIに強制する}

\affiliate{METASEPI}{METASEPI DESIGN}

\author{岡部 究}{Kiwamu Okabe}{METASEPI}[kiwamu@debian.or.jp]

\begin{abstract}
概要（400字程度） xxx
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○○
\end{abstract}

\begin{jkeyword}
ATS, 関数型言語, 依存型, 線形型, 組込開発
\end{jkeyword}

\maketitle

% Body %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{はじめに}

「モノのインターネット (IoT：Internet of Things)」という概念が提唱されています。バスケットボールのような、なんの変哲もないモノがマイクロチップを内蔵してインターネットに接続されるような世界を予想した概念がIoTです。そのIoTによる製造業への経済効果は2850億ドルと試算されています (ガートナー調べ \cite{iot_monoist})。このようなIoTデバイスに対する要件は以下のようなものになるでしょう。

\begin{itemize}
\item インターネットに接続可能なネットワークプロトコルを内蔵
\item 短時間/少工数による設計
\item 個人情報を保管/送信する機能
\item セキュリティへの配慮
\item ネットワーク非対応な機器よりもさらにインテリジェントな機能
\item 安価な価格を実現するため非力なハードウェアの使用
\end{itemize}

一方、現代の組み込み機器はC言語やC++言語を用いて慎重に開発されています。これはこれらの言語を使った開発手法が様々な不具合を誘発するためです。このような不具合の誘発を防ぐために、VDM \cite{vdm} やZ \cite{z_notation} のような形式手法が用いられます。しかし、これらの形式手法はモデルベースのものであり、実際に動作するC言語やC++言語で記述された設計と同期していません。これらのモデルとコードによる設計の同期には、やはり人間の力が必要になります。つまり製品のバージョンを更新する毎にこの形式手法モデルとソースコードを同期させる工数が恒常的に発生してしまいます。

これら慎重な開発はPOSIX API上でのアプリケーション開発と比較にならないほどの工数を必要とします。にもかかわず、IoTデバイスはそのような開発者にPOSIX上のアプリケーションレベルの機能を要求します。このC言語を中心とした開発プロセスは今後持続可能なものなのでしょうか？ソフトウェア理学/工学はこの問題に対して、有効な手を打てないのでしょうか？

本論文ではこの問題に対する1つの解決策としてATS言語 \cite{ats} を紹介します。このATS言語はMLのような関数型言語で、静的な強い型を持ちます。またこの言語は依存型とを持ち、Coq \cite{Coq_manual} のような証明器としても機能します。さらにこの言語の線形型を使うことで、メモリやロックのようなリソースの制御を安全に行なうことができます。ATS言語はC言語を経由して実行バイナリを生成するため、強い型による不変条件の強制は常にソースコードと同期しています。そのため製品のバージョンを数年にわたって更新する場合でも型とソースコードは機械的に同期します。最後にわずか8kBのメモリしか持たないArduino Mega 2560ボード \cite{arduino-mega} 上でATS言語を使って設計したアプリケーションを動作させ、組み込み領域にATS言語を適用可能であることを示します。

\section{既存の組込開発手法の問題}

xxx

\section{ATS言語とは}

xxx

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/flow.eps}
\caption{xxx}
\label{fig:flow}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/enforce_invariant.eps}
\caption{xxx}
\label{fig:enforce_invariant}
\end{figure}

\section{ATSの型について}

xxx

\begin{figure}[h]
\centering
\includegraphics[width=50mm]{draw/list_vt_type.eps}
\caption{xxx}
\label{fig:xxx}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/list_vt_make_pair.eps}
\caption{xxx}
\label{fig:xxx}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/list_vt_append.eps}
\caption{xxx}
\label{fig:list_vt_append}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/list_vt_get_at.eps}
\caption{xxx}
\label{fig:xxx}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/list_vt_reverse.eps}
\caption{xxx}
\label{fig:xxx}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/list_vt_free.eps}
\caption{xxx}
\label{fig:xxx}
\end{figure}

\section{ArduinoにおけるATSプログラミング}

ATS言語による組み込み開発の適正を評価するために、Arduino Mega 2560ボード上で動作するアプリケーションをATS言語で試作した。このボードは以下のような仕様である。

\begin{description}
  \item[Architecture] 8-bit Harvard architecture
  \item[Microcontroller] ATmega2560
  \item[Flash Memory] 256kB
  \item[SRAM] 8kB
  \item[Clock Speed] 16MHz
\end{description}

本稿を執筆している段階では、さらにメモリの少ないArduino Unoボード \cite{arduino-uno} 上でも同様のアプリケーションの動作に成功している。このアプリケーションのソースコードは \cite{arduino-ats} から入手可能である。

\begin{figure}[h]
\centering
\includegraphics[width=75mm]{draw/demo_ats_arduino.eps}
\caption{Arduino上におけるATSアプリケーション例}
\label{fig:demo_ats_arduino}
\end{figure}

本アプリケーションのアーキティクチャは図\ref{fig:demo_ats_arduino}のようなものである。本アプリケーションはハードウェアの機能としてGPIOとシリアルポートを使用する。GPIOはArduinoのGPIOライブラリを経由してATS言語から使用する。シリアルポートのレジスタ群にはATS言語から直接さわることにした。ただし、シリアルポートから読み書きするデータを一時保管するリングバッファについてはArduinoライブラリを流用している。この2つの抽象化によって、どのようなOSのサポートなしに、さらにGCやmallocヒープさえ準備せずにATS言語を使ってアプリケーションを書くことができます。

なぜGCとmallocヒープなしに強い型を用いた関数型プログラミングを行なうことが可能なのでしょうか？それはATS言語が値渡し(call-by-value)をコアにしていることと、線形型を使ったメモリリソースの管理によって実現されています。線形型を使うことで固定領域のメモリを安全に使用することが可能になり、さらにその領域外へのアクセスをメモリ領域のサイズに依存した依存型を使って防止することも可能です。

\section{ATSによる組込開発手法の考察}

前章でATS言語を使ってOS不在の領域における組み込み開発が可能なことを示しました。本章ではATS言語を用いた組み込み開発の利点と欠点についてまとめます。

その利点は静的な強い型と依存型、線形型をOSなしに利用することができることです。これまでこのような型による制約はPOSIX APIのようなインターフェイスを下支えするOSなしには利用できませんでした。そのため形式手法を用いた後付けによる制約強制手法が盛んに用いられてきました。型による制約によって実機で動作させるソースコードに制約を付けることが可能になります。製品バージョンを重ねてソースコードが成長したとしても、この制約は機械的に引き継がれることになります。これは今までの形式手法とは全く異なるレベルの画期的な技術です。

一方、欠点もあります。GCを持つHaskellやOCamlのような関数型言語と比較すると、GCを使わずに線形型を用いるATSプログラミングは他のプログラミング言語には見られない特殊な設計能力が要求されます。近年、線形型を使用可能な言語としてRust言語 \cite{rust} も人気ですが、Rust言語は純粋な線形型をではなくポインタに限定して線形型を用います。著者もHaskellとOCamlのプログラミング経験はありましたが、ATS言語の依存型と線形型に慣れるのにはかなりの時間が必要でした。現在組み込み開発の現場ではC言語とC++言語を使っているため、一般的な関数型言語とさらに加えてATS言語を習熟するのは容易ではありません。

\section{結論と今後の課題}

ATS言語による強い型の強制がOSさえないような組み込みドメインに対して有用であることを述べました。しかし、ATS言語の力を普及させるためにはATS言語の教育プログラムが重要であることも考察しました。そこで筆者は2つのプロジェクトを運営しています。

1つ目は、Japan ATS User Group (JATS-UG) \cite{jats-ug} です。このプロジェクトではインターネット上で入手可能なATS言語に関する文献を日本語に随時翻訳しています。特に「ATSプログラミング入門 \cite{INT2PROGINATS-J}」は有用でしょう。本稿執筆時点ではこのドキュメントが最も体系的にATS言語を解説しています。また、線形型に関しても本稿執筆時点では日本語で読める最も詳しいドキュメントでしょう。またATS言語の型システムを理論的に解説した論文Applied Type System (Extended Abstract) \cite{ATStypes03} も日本語訳しています。詳細は先のJATS-UGのWebページをご覧ください。

2つ目は、Functional IoTプロジェクト \cite{fpiot} です。このプロジェクトでは8-bit AVRと16-bit MSP430、32-bit ARM Cortex-Mの3つのアーキティクチャを対象として、ATS言語のような強い静的な型を持つ言語を使ったマイコンプログラミングを試行しています。このプロジェクトにはさらに2つの目的があります。1つ目はこのプロジェクトを通してATS言語のような組み込み領域に適用可能なプログラミング言語をサーベイすること。2つ目は製品よりも小さな領域の関数型組み込みプログラミングを通じて、そのデザインパターンを蓄積することです。日本のみならず世界を見わたしてもこの規模のアーキティクチャ上で動作する関数型プログラミングの実例はほとんどありません。そのため依存型や線形型をどのように駆使すべきであるのか、そのイディオムが圧倒的に不足しています。

最後に、先の論文Applied Type Systemは2004年に発行されています。しかしATS言語の作者であるHongwei Xiの知るかぎりでは、この型システムの実用例はATS言語のみであるそうです。関数型言語の持つ安全性がOSの外の領域でも活用できるために、このApplied Type Systemのさらに先にある理論の探求がさかんに行なわれることを願ってやみません。彼のメッセージを引用して、本稿を締め括ろうと思います。``Truly deliver safety-wise as well as performance-wise. - Hongwei Xi''

\begin{acknowledgment}
ATS言語に関して助言をくれたボストン大学の准教授であるHongwei XiとATSコミュニティに感謝します。
\end{acknowledgment}

\begin{QandA}
\item[A] 線形型にvalで別名を作るとどうなるのか？
\item[岡部] 消費される。以下に例を付記する。

\begin{verbatim}
(* コンパイルNG: let valでも線形型が消費されてしまう *)
#include "share/atspre_staload.hats"
implement main0 () = {
  val l1 = list_vt_make_pair<int> (1, 2)
  val l2 = l1
  val () = let val l3 = l2
           in println! l3 end
  val () = free l2
}

(* コンパイルOK: valで線形型が消費される *)
#include "share/atspre_staload.hats"
implement main0 () = {
  val l1 = list_vt_make_pair<int> (1, 2)
  val l2 = l1
  val () = println! l2
  val () = free l2
}
\end{verbatim}

\item[B] リングバッファをATSで書くのは難しいのか？
\item[岡部] 公式ドキュメントに例があるぐらいなので、リングバッファ自体は簡単。しかし、スレッドセーフ化や再入可能にするのはそれなりに難しい。
\item[C] マルチスレッドを生かしたプログラミングをするにはどうすれば良いか？
\item[岡部] セッションのようなものを作る。例えばmutexのロックと開放では、その間にセッションが存在すると考えることができる。セッションの間は静的な型を効果的に使うことができる。
\item[D] ATSに辿りつくまでのMetasepiプロジェクトの歴史について
\item[岡部] ATSを使ったイテレーションは2番目。1番目ではHaskell言語とjhcコンパイラを使っていた。Haskellの欠点は、メモリ領域の扱いがルーズ、マシン表現と言語表現にギャップがあること。ATSの欠点は、抽象化の機能が弱いこと。
\end{QandA}

% BibTeX を使用する場合 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliographystyle{ipsjsort}
\bibliography{../bibtex/reference,../bibtex/jreference}

\end{document}
